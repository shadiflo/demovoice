<!DOCTYPE html>
<html>

<head>
    <title>CS2 Voice Extractor</title>
    <link rel="icon" type="image/svg+xml" href="/icons/favicon.svg">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: #1a1a1a;
            color: #e0e0e0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        .card {
            background: #2a2a2a;
            border: 1px solid #3a3a3a;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
        }

        .player-card {
            background: #2a2a2a;
            border: 2px solid #4a90e2;
            margin-top: 0.5rem;
        }

        .player-card .card-body {
            padding: 0.5rem;
        }

        .player-name {
            font-weight: 600;
            text-decoration: none;
            color: #e0e0e0;
        }

        .player-name:hover {
            color: #4a90e2;
        }

        .badge-elo {
            background: #4a90e2;
            color: white;
            font-weight: 600;
        }

        .badge-stats {
            background: #4a90e2;
            color: white;
            font-size: 0.75rem;
        }

        .btn-group-sm .btn {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
        }

        .btn-outline-primary {
            color: #4a90e2;
            border-color: #4a90e2;
        }

        .btn-outline-primary:hover {
            background: #4a90e2;
            color: white;
        }

        .btn-primary {
            background: #4a90e2;
            border-color: #4a90e2;
        }

        .btn-primary:hover {
            background: #3a7bc8;
            border-color: #3a7bc8;
        }

        .btn-outline-secondary {
            color: #888;
            border-color: #444;
        }

        .btn-outline-secondary:hover {
            background: #444;
            color: #e0e0e0;
        }

        .waveform-container {
            height: 40px;
            background: #1a1a1a;
            border-radius: 4px;
            position: relative;
            cursor: pointer;
            overflow: hidden;
        }

        .waveform-canvas {
            width: 100%;
            height: 100%;
        }

        .waveform-progress {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            background: rgba(74, 144, 226, 0.2);
            border-right: 2px solid #4a90e2;
            pointer-events: none;
        }

        .volume-slider {
            width: 50%;
        }

        .team-header {
            font-size: 1.5rem;
            font-weight: 700;
            color: #e0e0e0;
        }

        .list-group-item {
            background: #2a2a2a;
            border-color: #3a3a3a;
            border-left: none;
            border-right: none;
            color: #e0e0e0;
        }

        .upload-section {
            background: #2a2a2a;
            border: 1px solid #3a3a3a;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
        }

        .alert-primary {
            background: #1e3a5f;
            border-color: #2a4a6a;
            color: #ffffff;
            font-weight: 500;
        }

        .form-control {
            background: #1a1a1a;
            border-color: #3a3a3a;
            color: #ffffff;
        }

        .form-control:focus {
            background: #1a1a1a;
            border-color: #4a90e2;
            color: #ffffff;
        }

        .form-control::placeholder {
            color: #888888;
            opacity: 1;
        }

        .form-range {
            background: transparent;
        }

        .history-btn {
            padding: 0.15rem 0.4rem;
            font-size: 0.75rem;
        }

        .copy-btn {
            cursor: pointer;
        }

        .copy-btn:hover {
            opacity: 0.8;
        }

        .loading-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .loading-modal.active {
            display: flex;
        }

        .loading-content {
            background: #2a2a2a;
            border: 1px solid #3a3a3a;
            border-radius: 12px;
            padding: 2rem;
            text-align: center;
            color: #e0e0e0;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid #3a3a3a;
            border-top: 3px solid #4a90e2;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Processing spinner - large centered */
        .processing-spinner {
            width: 80px;
            height: 80px;
            border: 4px solid #3a3a3a;
            border-top: 4px solid #4a90e2;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 2rem auto;
        }

        /* Skeleton loading animation */
        .skeleton {
            background: linear-gradient(90deg, #2a2a2a 25%, #3a3a3a 50%, #2a2a2a 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }

        @keyframes shimmer {
            0% {
                background-position: 200% 0;
            }

            100% {
                background-position: -200% 0;
            }
        }

        .skeleton-card {
            background: #2a2a2a;
            border: 2px solid #3a3a3a;
            border-radius: 8px;
            margin-top: 0.5rem;
            padding: 0.75rem;
        }

        .skeleton-name {
            height: 20px;
            width: 60%;
            border-radius: 4px;
            margin-bottom: 0.5rem;
        }

        .skeleton-elo {
            height: 20px;
            width: 80px;
            border-radius: 12px;
            float: right;
        }

        .skeleton-waveform {
            height: 40px;
            width: 100%;
            border-radius: 4px;
            margin: 0.5rem 0;
        }

        .skeleton-buttons {
            height: 28px;
            width: 100%;
            border-radius: 4px;
        }
    </style>
</head>

<body>
    <main class="container py-3">
        <!-- Alert Banner -->
        <div class="row">
            <div class="col-12">
                <div class="alert alert-primary" role="alert">
                    <p class="mb-0">Upload a CS2 demo file or enter a Faceit matchroom URL to extract voice
                        communications.</p>
                </div>
            </div>
        </div>

        <!-- Upload Section -->
        <div class="upload-section">
            <div class="row">
                <div class="col-md-6">
                    <h6 class="fw-bold mb-2">Option 1: Upload Demo File</h6>
                    <form action="/upload" method="post" enctype="multipart/form-data" id="uploadForm">
                        <div class="input-group">
                            <input type="file" name="demo" accept=".dem" id="demoFile" class="form-control">
                            <button type="submit" class="btn btn-primary" id="submitButton">Extract</button>
                        </div>
                    </form>
                </div>
                <div class="col-md-6">
                    <h6 class="fw-bold mb-2">Option 2: Faceit Matchroom URL</h6>
                    <form action="/download-from-url" method="post" id="urlForm">
                        <div class="input-group">
                            <input type="text" name="matchroom_url"
                                placeholder="https://www.faceit.com/en/cs2/room/1-..." id="matchroomURL"
                                class="form-control">
                            <button type="submit" class="btn btn-primary" id="urlSubmitButton">Download</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        {{if .CurrentDemo}}
        <!-- Match Metadata Header -->
        <div class="row">
            <div class="col-12 p-0">
                <div class="list-group list-group-horizontal text-center">
                    <span class="list-group-item col-md-4">
                        <h2 class="mb-1 mt-1 team-header" id="team1Name">Team 1</h2>
                    </span>
                    <span class="list-group-item col-md-4">
                        <span id="demoInfo">{{.CurrentDemo.Filename}}</span>
                    </span>
                    <span class="list-group-item col-md-4">
                        <h2 class="mb-1 mt-1 team-header" id="team2Name">Team 2</h2>
                    </span>
                </div>
            </div>
        </div>

        <!-- Match Data -->
        <div class="row" id="matchContainer" data-match-id="{{.CurrentDemo.MatchID}}">
            <!-- Team 1 -->
            <span class="col-md-4 px-0 py-2" id="team1Container">
                <div class="text-center py-4" style="color: #ffffff;">Loading team data...</div>
            </span>

            <!-- Center Options -->
            <span class="col-md-4 py-2" id="optionsContainer">
                <!-- Processing Status - Large Spinner -->
                <div class="card mt-1" id="processingCard" style="display: none;">
                    <div class="card-body text-center py-4">
                        <div class="processing-spinner"></div>
                        <h5 style="color: #ffffff;" id="processingTitle">Processing Demo</h5>
                        <p class="mb-0" style="color: #888;" id="processingText">Extracting voice data...</p>
                    </div>
                </div>

                <!-- Normal Options - Shown when complete -->
                <div class="card mt-1" id="optionsCard">
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item" id="matchroomButtonContainer">
                            <div class="btn-group col-md-12" id="matchLinks">
                                <a href="#" class="btn btn-primary" id="matchroomLink" target="_blank">Matchroom</a>
                                <button class="btn btn-outline-primary" id="shareLobbyBtn" onclick="shareLobby()">
                                    <i class="fas fa-share-alt"></i> Share
                                </button>
                            </div>
                        </li>
                        <li class="list-group-item" id="shareUrlContainer" style="display: none;">
                            <div class="input-group">
                                <input type="text" class="form-control" id="shareUrlInput" readonly>
                                <button class="btn btn-outline-primary" onclick="copyShareUrl()">
                                    <i class="fas fa-copy"></i>
                                </button>
                            </div>
                            <small class="text-muted" id="shareCopyFeedback"></small>
                        </li>
                        <li class="list-group-item">
                            <form action="/" method="get" class="mb-0">
                                <div class="input-group">
                                    <input type="text" class="form-control" placeholder="Search for a match"
                                        id="searchInput">
                                    <button class="btn btn-outline-secondary" type="submit">GO!</button>
                                </div>
                            </form>
                        </li>
                        <li class="list-group-item {{if not .CurrentDemo.ChatLog}}d-none{{end}}"
                            id="chatLogButtonContainer">
                            <button onclick="viewChatLog('{{.CurrentDemo.ChatLog}}')" id="chatLogBtn"
                                class="btn btn-outline-secondary w-100">
                                <i class="fas fa-comments"></i> View Chat Logs
                            </button>
                            <small class="text-muted d-block text-center mt-1" style="font-size: 0.7rem;">
                                From demo events (server/client commands may vary)
                            </small>
                        </li>
                    </ul>
                </div>
            </span>

            <!-- Team 2 -->
            <span class="col-md-4 px-0 py-2" id="team2Container">
                <div class="text-center py-4" style="color: #ffffff;">Loading team data...</div>
            </span>
        </div>

        {{else}}
        <!-- No Demo State -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-body text-center py-5">
                        <h4 style="color: #ffffff;">Ready to Analyze</h4>
                        <p style="color: #ffffff;">Upload a CS2 demo file (.dem) or enter a Faceit matchroom URL</p>
                    </div>
                </div>
            </div>
        </div>
        {{end}}
    </main>

    <!-- Loading Modal -->
    <div class="loading-modal" id="loadingModal">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <div class="loading-text">Processing...</div>
        </div>
    </div>

    <!-- Chat Log Modal -->
    <div class="modal fade" id="chatLogModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content" style="background: #2a2a2a; border: 1px solid #3a3a3a; color: #e0e0e0;">
                <div class="modal-header d-block" style="border-bottom: 1px solid #3a3a3a;">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h5 class="modal-title mb-0">Match Chat Logs</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                            aria-label="Close"></button>
                    </div>
                    <input type="text" id="chatFilterInput" class="form-control form-control-sm"
                        placeholder="Filter by player name..." onkeyup="filterChatLog()">
                </div>
                <div class="modal-body p-0">
                    <pre id="chatLogContent" class="m-0 p-3"
                        style="max-height: 60vh; overflow-y: auto; background: #1a1a1a; font-family: 'Consolas', 'Monaco', monospace; font-size: 0.9rem; color: #a0a0a0; white-space: pre-wrap;"></pre>
                </div>
                <div class="modal-footer" style="border-top: 1px solid #3a3a3a;">
                    <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary btn-sm" onclick="copyChatLog()">Copy All</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    {{if .CurrentDemo}}
    <div id="demo-data" data-players='{{.PlayersJSON}}'
        data-cached-match='{{if .CachedMatchData}}{{.CachedMatchData}}{{else}}null{{end}}' style="display:none;"></div>
    <script>
        const matchID = '{{.CurrentDemo.MatchID}}';
        const demoID = '{{.CurrentDemo.DemoID}}';
        const demoStatus = '{{.CurrentDemo.Status}}';

        // Set matchroom link immediately if we have a matchID
        if (matchID) {
            const matchroomLink = document.getElementById('matchroomLink');
            if (matchroomLink) {
                matchroomLink.href = 'https://www.faceit.com/en/cs2/room/' + matchID;
            }
        }

        const demoData = document.getElementById('demo-data');
        let players = JSON.parse(demoData.getAttribute('data-players') || '[]');
        let audioMap = {};
        let matchDataCache = null;
        let statusPollInterval = null;

        // Cached match data for instant loading
        const cachedMatchDataRaw = JSON.parse(demoData.getAttribute('data-cached-match') || 'null');
        if (cachedMatchDataRaw && cachedMatchDataRaw.payload) {
            matchDataCache = cachedMatchDataRaw.payload;
        } else if (cachedMatchDataRaw && cachedMatchDataRaw.teams) {
            // Handle case where payload is the root object
            matchDataCache = cachedMatchDataRaw;
        }

        // Create audio map
        function updateAudioMap() {
            audioMap = {};
            players.forEach(p => {
                if (p.AudioFile) {
                    audioMap[p.SteamID] = p.AudioFile;
                    if (p.AudioLength) {
                        audioMap[p.SteamID + '_length'] = p.AudioLength;
                    }
                }
            });
        }
        updateAudioMap();

        // Generate skeleton player cards HTML
        function generateSkeletonCards(count) {
            let html = '';
            for (let i = 0; i < count; i++) {
                html += `
                <div class="skeleton-card">
                    <div style="overflow: hidden;">
                        <div class="skeleton skeleton-name"></div>
                        <div class="skeleton skeleton-elo"></div>
                    </div>
                    <div class="skeleton skeleton-waveform"></div>
                    <div class="skeleton skeleton-buttons"></div>
                </div>`;
            }
            return html;
        }

        // Status polling while processing
        function startStatusPolling() {
            if (demoStatus === 'completed') return;

            // Show processing spinner, hide options
            document.getElementById('processingCard').style.display = 'block';
            document.getElementById('optionsCard').style.display = 'none';

            // Show skeleton player cards (5 per team)
            document.getElementById('team1Container').innerHTML = generateSkeletonCards(5);
            document.getElementById('team2Container').innerHTML = generateSkeletonCards(5);

            statusPollInterval = setInterval(() => {
                fetch('/status?demo_id=' + demoID)
                    .then(r => {
                        console.log('Status response:', r.status);
                        if (!r.ok) throw new Error('Status API returned ' + r.status);
                        return r.json();
                    })
                    .then(data => {
                        console.log('Status data:', data);
                        if (data.status === 'completed') {
                            clearInterval(statusPollInterval);

                            // Hide processing spinner, show options
                            document.getElementById('processingCard').style.display = 'none';
                            document.getElementById('optionsCard').style.display = 'block';

                            // Update players if available
                            if (data.players && data.players.length > 0) {
                                players = data.players;
                                updateAudioMap();
                                console.log('Updated players:', players.length, 'Audio map:', audioMap);
                            }

                            // Show chat log button if available
                            if (data.chat_log) {
                                const btnContainer = document.getElementById('chatLogButtonContainer');
                                const btn = document.getElementById('chatLogBtn');
                                if (btnContainer && btn) {
                                    btn.setAttribute('onclick', `viewChatLog('${data.chat_log}')`);
                                    btnContainer.style.display = 'block';
                                }
                            }

                            // Always try to render, even with no players
                            if (matchDataCache) {
                                console.log('Rendering teams with cached match data');
                                renderTeams(matchDataCache);
                            } else if (matchID) {
                                console.log('Fetching and rendering teams');
                                fetchAndRenderTeams();
                            } else {
                                console.log('Rendering fallback');
                                renderFallback();
                            }

                            // document.getElementById('loadingModal').classList.remove('active');
                        } else if (data.status === 'failed') {
                            clearInterval(statusPollInterval);
                            // Hide processing spinner, show options
                            document.getElementById('processingCard').style.display = 'none';
                            document.getElementById('optionsCard').style.display = 'block';
                            document.getElementById('processingTitle').textContent = 'Processing Failed';
                            document.getElementById('processingText').textContent = 'Could not extract voice data';
                            alert('Processing failed.');
                        } else {
                            console.log('Still processing... status:', data.status);
                        }
                    })
                    .catch(err => {
                        console.error('Status polling error:', err);
                        // Don't stop polling on errors, but log them
                    });
            }, 3000); // Poll every 3 seconds to reduce server load
        }

        // Fetch and render teams
        function fetchAndRenderTeams() {
            if (!matchID) {
                console.log('No matchID, rendering fallback');
                renderFallback();
                return;
            }

            console.log('Fetching match data for matchID:', matchID);
            fetch('/faceit/match?matchid=' + matchID)
                .then(r => {
                    console.log('Match API response status:', r.status);
                    if (!r.ok) throw new Error('Match API returned ' + r.status);
                    return r.json();
                })
                .then(data => {
                    console.log('Match data received:', data);
                    // Check for teams in both possible locations (API structure changed)
                    const hasTeams = data.payload && (
                        (data.payload.teams && data.payload.teams.faction1) ||
                        (data.payload.entityCustom && data.payload.entityCustom.teams)
                    );
                    if (hasTeams) {
                        matchDataCache = data.payload;
                        console.log('Rendering teams with fetched match data');
                        renderTeams(data.payload);
                    } else {
                        console.log('Invalid match data structure, rendering fallback');
                        renderFallback();
                    }
                    // document.getElementById('loadingModal').classList.remove('active');
                })
                .catch(err => {
                    console.error('Error fetching match data:', err);
                    renderFallback();
                    // document.getElementById('loadingModal').classList.remove('active');
                });
        }

        // Render teams from match data
        function renderTeams(matchData) {
            console.log('renderTeams called with:', matchData);
            console.log('Current audioMap:', audioMap);

            // Handle both API structures (teams under .teams or .entityCustom.teams)
            let faction1, faction2;
            if (matchData.teams && matchData.teams.faction1) {
                faction1 = matchData.teams.faction1;
                faction2 = matchData.teams.faction2;
            } else if (matchData.entityCustom && matchData.entityCustom.teams) {
                faction1 = matchData.entityCustom.teams.faction1;
                faction2 = matchData.entityCustom.teams.faction2;
            } else {
                console.error('No teams found in match data');
                renderFallback();
                return;
            }

            console.log('Team 1:', faction1.name, 'Players:', faction1.roster.length);
            console.log('Team 2:', faction2.name, 'Players:', faction2.roster.length);

            // Update team names
            document.getElementById('team1Name').textContent = faction1.name;
            document.getElementById('team2Name').textContent = faction2.name;

            // Update match links
            if (matchID) {
                document.getElementById('matchroomLink').href = 'https://www.faceit.com/en/cs2/room/' + matchID;
            }

            // Render team 1
            document.getElementById('team1Container').innerHTML = renderTeamPlayers(faction1);

            // Render team 2
            document.getElementById('team2Container').innerHTML = renderTeamPlayers(faction2);

            console.log('Teams rendered, initializing audio players in 300ms...');
            // Initialize audio players
            setTimeout(initAudioPlayers, 300);
        }

        // Render players for a team
        function renderTeamPlayers(team) {
            return team.roster.map(player => {
                const audioFile = audioMap[player.gameId] || null;
                const elo = player.elo || 0;
                const level = player.gameSkillLevel || 1;

                const audioLength = audioMap[player.gameId + '_length'] || '';

                return `
                <div class="card player-card">
                    <div class="card-body">
                        <h5 class="card-title mb-1">
                            <span class="player-name">${player.nickname}</span>
                            <span class="badge badge-elo rounded-pill float-end">${elo} ELO</span>
                        </h5>
                        ${audioLength ? `<p class="mb-0" style="font-size: 0.85rem; color: #ffffff;">${audioLength}</p>` : ''}
                        ${!audioFile ? `<p class="mb-0" style="font-size: 0.85rem; color: #888888;">User didn't use microphone</p>` : ''}
                    </div>
                    ${audioFile ? `
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item p-0 m-0">
                            <div class="waveform-container" data-audio="/output/${audioFile}" onclick="seekAudio(event, this)">
                                <canvas class="waveform-canvas"></canvas>
                                <div class="waveform-progress"></div>
                            </div>
                        </li>
                        <li class="list-group-item p-0 m-0">
                            <input type="range" class="form-range volume-slider" min="0" max="2" value="1" step="0.01" onchange="setVolume(this)">
                        </li>
                    </ul>
                    ` : ''}
                    <div class="card-body p-1">
                        <div class="btn-group btn-group-sm">
                            <a href="https://steamcommunity.com/profiles/${player.gameId}" target="_blank" class="btn btn-outline-primary">Steam</a>
                            <a href="https://www.faceit.com/en/players/${player.nickname}" target="_blank" class="btn btn-outline-primary">Faceit</a>
                            ${audioFile ? `
                            <button class="btn btn-primary play-btn" onclick="togglePlay(this)" data-audio="/output/${audioFile}">Play</button>
                            <a href="/output/${audioFile}" download class="btn btn-outline-primary" title="Download">DL</a>
                            ` : ''}
                        </div>
                        <audio class="d-none" ${audioFile ? `src="/output/${audioFile}"` : ''} preload="metadata"></audio>
                    </div>
                </div>
            `;
            }).join('');
        }

        // Fallback render when no match data
        function renderFallback() {
            console.log('renderFallback called, players:', players.length);
            console.log('Current audioMap:', audioMap);

            const team1 = players.slice(0, Math.ceil(players.length / 2));
            const team2 = players.slice(Math.ceil(players.length / 2));

            console.log('Team 1:', team1.length, 'players, Team 2:', team2.length, 'players');

            document.getElementById('team1Container').innerHTML = team1.map(p => renderFallbackPlayer(p)).join('');
            document.getElementById('team2Container').innerHTML = team2.map(p => renderFallbackPlayer(p)).join('');

            console.log('Fallback rendered, initializing audio players in 300ms...');
            setTimeout(initAudioPlayers, 300);
        }

        function renderFallbackPlayer(player) {
            const audioFile = player.AudioFile || audioMap[player.SteamID];
            const nickname = player.Nickname || 'Loading...';
            const elo = player.FaceitElo || 0;
            const audioLength = player.AudioLength || audioMap[player.SteamID + '_length'] || '';

            return `
            <div class="card player-card" data-steam-id="${player.SteamID}">
                <div class="card-body">
                    <h5 class="card-title mb-1">
                        <span class="player-name">${nickname}</span>
                        ${elo > 0 ? `<span class="badge badge-elo rounded-pill float-end">${elo} ELO</span>` : ''}
                    </h5>
                    ${audioLength ? `<p class="mb-0" style="font-size: 0.85rem; color: #ffffff;">${audioLength}</p>` : ''}
                    ${!audioFile ? `<p class="mb-0" style="font-size: 0.85rem; color: #888888;">User didn't use microphone</p>` : ''}
                </div>
                ${audioFile ? `
                <ul class="list-group list-group-flush">
                    <li class="list-group-item p-0 m-0">
                        <div class="waveform-container" data-audio="/output/${audioFile}" onclick="seekAudio(event, this)">
                            <canvas class="waveform-canvas"></canvas>
                            <div class="waveform-progress"></div>
                        </div>
                    </li>
                    <li class="list-group-item p-0 m-0">
                        <input type="range" class="form-range volume-slider" min="0" max="2" value="1" step="0.01" onchange="setVolume(this)">
                    </li>
                </ul>
                ` : ''}
                <div class="card-body p-1">
                    <div class="btn-group btn-group-sm">
                        <a href="https://steamcommunity.com/profiles/${player.SteamID}" target="_blank" class="btn btn-outline-primary">Steam</a>
                        ${nickname !== 'Loading...' ? `<a href="https://www.faceit.com/en/players/${nickname}" target="_blank" class="btn btn-outline-primary">Faceit</a>` : ''}
                        ${audioFile ? `
                        <button class="btn btn-primary play-btn" onclick="togglePlay(this)" data-audio="/output/${audioFile}">Play</button>
                        <a href="/output/${audioFile}" download class="btn btn-outline-primary">DL</a>
                        ` : ''}
                    </div>
                    <audio class="d-none" ${audioFile ? `src="/output/${audioFile}"` : ''} preload="metadata"></audio>
                </div>
            </div>
        `;
        }

        // Audio controls
        function togglePlay(btn) {
            const card = btn.closest('.player-card');
            const audio = card.querySelector('audio');
            if (!audio) return;

            if (audio.paused) {
                // Pause all other audio
                document.querySelectorAll('audio').forEach(a => {
                    if (a !== audio) {
                        a.pause();
                        const otherBtn = a.closest('.player-card')?.querySelector('.play-btn');
                        if (otherBtn) otherBtn.textContent = 'Play';
                    }
                });
                audio.play();
                btn.textContent = 'Pause';
            } else {
                audio.pause();
                btn.textContent = 'Play';
            }
        }

        function setVolume(slider) {
            const card = slider.closest('.player-card');
            const audio = card.querySelector('audio');
            if (audio) audio.volume = slider.value;
        }

        function seekAudio(event, container) {
            const card = container.closest('.player-card');
            const audio = card.querySelector('audio');
            if (!audio || !audio.duration) return;

            const rect = container.getBoundingClientRect();
            const x = event.clientX - rect.left;
            audio.currentTime = (x / rect.width) * audio.duration;
        }

        // View chat log
        let currentChatLogText = '';

        function viewChatLog(filename) {
            if (!filename) return;

            const content = document.getElementById('chatLogContent');
            content.textContent = 'Loading chat logs...';
            document.getElementById('chatFilterInput').value = ''; // Reset filter

            const modal = new bootstrap.Modal(document.getElementById('chatLogModal'));
            modal.show();

            fetch('/output/' + filename)
                .then(r => {
                    if (!r.ok) throw new Error('Failed to load chat log');
                    return r.text();
                })
                .then(text => {
                    currentChatLogText = text;
                    if (!text.trim()) {
                        content.textContent = 'No chat messages recorded in this demo.';
                    } else {
                        content.textContent = text;
                    }
                })
                .catch(err => {
                    console.error('Error loading chat:', err);
                    content.textContent = 'Error loading chat logs: ' + err.message;
                });
        }

        function filterChatLog() {
            const filter = document.getElementById('chatFilterInput').value.toLowerCase();
            const content = document.getElementById('chatLogContent');

            if (!currentChatLogText) return;

            if (!filter) {
                content.textContent = currentChatLogText;
                return;
            }

            const lines = currentChatLogText.split('\n');
            const filteredLines = lines.filter(line => line.toLowerCase().includes(filter));

            if (filteredLines.length === 0) {
                content.textContent = 'No messages found for "' + filter + '"';
            } else {
                content.textContent = filteredLines.join('\n');
            }
        }

        function copyChatLog() {
            const content = document.getElementById('chatLogContent').textContent;
            navigator.clipboard.writeText(content).then(() => {
                alert('Chat logs copied to clipboard!');
            });
        }


        // Initialize audio players with waveforms


        // Initialize audio players with waveforms
        function initAudioPlayers() {
            const containers = document.querySelectorAll('.waveform-container');
            console.log('initAudioPlayers called, found', containers.length, 'waveform containers');

            containers.forEach((container, index) => {
                const card = container.closest('.player-card');
                const audio = card.querySelector('audio');
                const canvas = container.querySelector('.waveform-canvas');
                const progress = container.querySelector('.waveform-progress');

                console.log(`Player ${index + 1}:`, {
                    hasAudio: !!audio,
                    hasCanvas: !!canvas,
                    audioSrc: audio?.src
                });

                if (!audio || !canvas) {
                    console.warn(`Skipping player ${index + 1}: missing audio or canvas`);
                    return;
                }

                audio.volume = 0.8;

                // Draw waveform
                drawWaveform(audio, canvas);

                // Update progress
                audio.addEventListener('timeupdate', () => {
                    if (audio.duration) {
                        progress.style.width = (audio.currentTime / audio.duration * 100) + '%';
                    }
                });

                audio.addEventListener('ended', () => {
                    const btn = card.querySelector('.play-btn');
                    if (btn) btn.textContent = 'Play';
                });
            });
        }

        function drawWaveform(audio, canvas) {
            if (!audio.src) return;

            fetch(audio.src)
                .then(r => r.arrayBuffer())
                .then(buffer => {
                    const ctx = new (window.AudioContext || window.webkitAudioContext)();
                    return ctx.decodeAudioData(buffer);
                })
                .then(audioBuffer => {
                    const canvasCtx = canvas.getContext('2d');
                    const width = canvas.width = canvas.offsetWidth * 2;
                    const height = canvas.height = canvas.offsetHeight * 2;
                    canvasCtx.scale(2, 2);

                    const displayW = canvas.offsetWidth;
                    const displayH = canvas.offsetHeight;

                    const data = audioBuffer.getChannelData(0);
                    const samples = 150;
                    const blockSize = Math.floor(data.length / samples);
                    const amplitudes = [];

                    for (let i = 0; i < samples; i++) {
                        let sum = 0;
                        for (let j = 0; j < blockSize; j++) {
                            sum += Math.abs(data[i * blockSize + j] || 0);
                        }
                        amplitudes.push(sum / blockSize);
                    }

                    const max = Math.max(...amplitudes);
                    const barW = displayW / samples;

                    amplitudes.forEach((amp, i) => {
                        const h = (amp / max) * displayH * 0.85;
                        const y = (displayH - h) / 2;
                        canvasCtx.fillStyle = '#0d6efd';
                        canvasCtx.fillRect(i * barW, y, barW - 0.5, h);
                    });
                })
                .catch(() => {
                    // Fallback: random bars
                    const canvasCtx = canvas.getContext('2d');
                    const w = canvas.offsetWidth;
                    const h = canvas.offsetHeight;
                    for (let i = 0; i < 80; i++) {
                        const barH = Math.random() * h * 0.6 + h * 0.2;
                        canvasCtx.fillStyle = '#0d6efd';
                        canvasCtx.fillRect(i * (w / 80), (h - barH) / 2, w / 80 - 1, barH);
                    }
                });
        }

        // Share lobby functions
        function shareLobby() {
            const shareUrl = window.location.origin + '/?demo_id=' + demoID;
            document.getElementById('shareUrlInput').value = shareUrl;
            document.getElementById('shareUrlContainer').style.display = 'block';
            document.getElementById('shareCopyFeedback').textContent = '';
        }

        function copyShareUrl() {
            const shareUrl = document.getElementById('shareUrlInput').value;
            navigator.clipboard.writeText(shareUrl).then(() => {
                document.getElementById('shareCopyFeedback').textContent = 'Copied to clipboard!';
                document.getElementById('shareCopyFeedback').style.color = '#4a90e2';
                setTimeout(() => {
                    document.getElementById('shareCopyFeedback').textContent = '';
                }, 2000);
            }).catch(() => {
                // Fallback for older browsers
                document.getElementById('shareUrlInput').select();
                document.execCommand('copy');
                document.getElementById('shareCopyFeedback').textContent = 'Copied!';
            });
        }

        // Initialize on load
        if (demoStatus !== 'completed') {
            startStatusPolling();
        } else if (matchDataCache) {
            renderTeams(matchDataCache);
        } else if (matchID) {
            fetchAndRenderTeams();
        } else {
            renderFallback();
        }

    </script>
    {{end}}
    <script>

        // Form handlers
        document.getElementById('uploadForm')?.addEventListener('submit', function (e) {
            if (!document.getElementById('demoFile').files[0]) {
                e.preventDefault();
                alert('Please select a demo file');
                return;
            }
            // Don't show modal - status will be inline
            // document.getElementById('loadingModal').classList.add('active');
            // document.querySelector('.loading-text').textContent = 'Uploading...';
            document.getElementById('submitButton').disabled = true;
        });

        document.getElementById('urlForm')?.addEventListener('submit', function (e) {
            const url = document.getElementById('matchroomURL').value.trim();
            if (!url || !url.includes('faceit.com') || !url.includes('/room/')) {
                e.preventDefault();
                alert('Please enter a valid Faceit matchroom URL');
                return;
            }
            // Don't show modal - status will be inline
            // document.getElementById('loadingModal').classList.add('active');
            // document.querySelector('.loading-text').textContent = 'Downloading demo...';
            document.getElementById('urlSubmitButton').disabled = true;
        });
    </script>
</body>

</html>