<!DOCTYPE html>
<html>
<head>
    <title>CS2 Voice Extractor</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: #1a1a1a;
            color: #e0e0e0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        .card {
            background: #2a2a2a;
            border: 1px solid #3a3a3a;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }
        .player-card {
            background: #2a2a2a;
            border: 2px solid #4a90e2;
            margin-top: 0.5rem;
        }
        .player-card .card-body {
            padding: 0.5rem;
        }
        .player-name {
            font-weight: 600;
            text-decoration: none;
            color: #e0e0e0;
        }
        .player-name:hover {
            color: #4a90e2;
        }
        .badge-elo {
            background: #4a90e2;
            color: white;
            font-weight: 600;
        }
        .badge-stats {
            background: #4a90e2;
            color: white;
            font-size: 0.75rem;
        }
        .btn-group-sm .btn {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
        }
        .btn-outline-primary {
            color: #4a90e2;
            border-color: #4a90e2;
        }
        .btn-outline-primary:hover {
            background: #4a90e2;
            color: white;
        }
        .btn-primary {
            background: #4a90e2;
            border-color: #4a90e2;
        }
        .btn-primary:hover {
            background: #3a7bc8;
            border-color: #3a7bc8;
        }
        .btn-outline-secondary {
            color: #888;
            border-color: #444;
        }
        .btn-outline-secondary:hover {
            background: #444;
            color: #e0e0e0;
        }
        .waveform-container {
            height: 40px;
            background: #1a1a1a;
            border-radius: 4px;
            position: relative;
            cursor: pointer;
            overflow: hidden;
        }
        .waveform-canvas {
            width: 100%;
            height: 100%;
        }
        .waveform-progress {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            background: rgba(74, 144, 226, 0.2);
            border-right: 2px solid #4a90e2;
            pointer-events: none;
        }
        .volume-slider {
            width: 50%;
        }
        .team-header {
            font-size: 1.5rem;
            font-weight: 700;
            color: #e0e0e0;
        }
        .list-group-item {
            background: #2a2a2a;
            border-color: #3a3a3a;
            border-left: none;
            border-right: none;
            color: #e0e0e0;
        }
        .upload-section {
            background: #2a2a2a;
            border: 1px solid #3a3a3a;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }
        .alert-primary {
            background: #2a3a4a;
            border-color: #3a4a5a;
            color: #a0c0e0;
        }
        .form-control {
            background: #1a1a1a;
            border-color: #3a3a3a;
            color: #e0e0e0;
        }
        .form-control:focus {
            background: #1a1a1a;
            border-color: #4a90e2;
            color: #e0e0e0;
        }
        .form-range {
            background: transparent;
        }
        .history-btn {
            padding: 0.15rem 0.4rem;
            font-size: 0.75rem;
        }
        .copy-btn {
            cursor: pointer;
        }
        .copy-btn:hover {
            opacity: 0.8;
        }
        .loading-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
        .loading-modal.active {
            display: flex;
        }
        .loading-content {
            background: #2a2a2a;
            border: 1px solid #3a3a3a;
            border-radius: 12px;
            padding: 2rem;
            text-align: center;
            color: #e0e0e0;
        }
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid #3a3a3a;
            border-top: 3px solid #4a90e2;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <main class="container py-3">
        <!-- Alert Banner -->
        <div class="row">
            <div class="col-12">
                <div class="alert alert-primary" role="alert">
                    <p class="mb-0">Upload a CS2 demo file or enter a Faceit matchroom URL to extract voice communications.</p>
                </div>
            </div>
        </div>

        <!-- Upload Section -->
        <div class="upload-section">
            <div class="row">
                <div class="col-md-6">
                    <h6 class="fw-bold mb-2">Option 1: Upload Demo File</h6>
                    <form action="/upload" method="post" enctype="multipart/form-data" id="uploadForm">
                        <div class="input-group">
                            <input type="file" name="demo" accept=".dem" id="demoFile" class="form-control">
                            <button type="submit" class="btn btn-primary" id="submitButton">Extract</button>
                        </div>
                    </form>
                </div>
                <div class="col-md-6">
                    <h6 class="fw-bold mb-2">Option 2: Faceit Matchroom URL</h6>
                    <form action="/download-from-url" method="post" id="urlForm">
                        <div class="input-group">
                            <input type="text" name="matchroom_url" placeholder="https://www.faceit.com/en/cs2/room/1-..." id="matchroomURL" class="form-control">
                            <button type="submit" class="btn btn-primary" id="urlSubmitButton">Download</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        {{if .CurrentDemo}}
        <!-- Match Metadata Header -->
        <div class="row">
            <div class="col-12 p-0">
                <div class="list-group list-group-horizontal text-center">
                    <span class="list-group-item col-md-4">
                        <h2 class="mb-1 mt-1 team-header" id="team1Name">Team 1</h2>
                    </span>
                    <span class="list-group-item col-md-4">
                        <span id="demoInfo">{{.CurrentDemo.Filename}}</span>
                    </span>
                    <span class="list-group-item col-md-4">
                        <h2 class="mb-1 mt-1 team-header" id="team2Name">Team 2</h2>
                    </span>
                </div>
            </div>
        </div>

        <!-- Match Data -->
        <div class="row" id="matchContainer" data-match-id="{{.CurrentDemo.MatchID}}">
            <!-- Team 1 -->
            <span class="col-md-4 px-0 py-2" id="team1Container">
                <div class="text-center text-muted py-4">Loading team data...</div>
            </span>

            <!-- Center Options -->
            <span class="col-md-4 py-2" id="optionsContainer">
                <div class="card mt-1">
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item">
                            <div class="btn-group col-md-12" id="matchLinks">
                                <a href="#" class="btn btn-primary" id="frontendLink" target="_blank">FrontEnd</a>
                            </div>
                        </li>
                        <li class="list-group-item">
                            <form action="/" method="get" class="mb-0">
                                <div class="input-group">
                                    <input type="text" class="form-control" placeholder="Search for a match" id="searchInput">
                                    <button class="btn btn-outline-secondary" type="submit">GO!</button>
                                </div>
                            </form>
                        </li>
                    </ul>
                </div>
            </span>

            <!-- Team 2 -->
            <span class="col-md-4 px-0 py-2" id="team2Container">
                <div class="text-center text-muted py-4">Loading team data...</div>
            </span>
        </div>

        {{else}}
        <!-- No Demo State -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-body text-center py-5">
                        <h4>Ready to Analyze</h4>
                        <p class="text-muted">Upload a CS2 demo file (.dem) or enter a Faceit matchroom URL</p>
                    </div>
                </div>
            </div>
        </div>
        {{end}}
    </main>

    <!-- Loading Modal -->
    <div class="loading-modal" id="loadingModal">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <div class="loading-text">Processing...</div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    {{if .CurrentDemo}}
    <script>
    const matchID = '{{.CurrentDemo.MatchID}}';
    const demoID = '{{.CurrentDemo.DemoID}}';
    const demoStatus = '{{.CurrentDemo.Status}}';
    let players = {{.PlayersJSON}};
    let audioMap = {};
    let matchDataCache = null;
    let statusPollInterval = null;

    // Cached match data for instant loading
    const cachedMatchDataRaw = {{if .CachedMatchData}}{{.CachedMatchData}}{{else}}null{{end}};
    if (cachedMatchDataRaw && cachedMatchDataRaw.payload) {
        matchDataCache = cachedMatchDataRaw.payload;
    }

    // Create audio map
    function updateAudioMap() {
        audioMap = {};
        players.forEach(p => {
            if (p.AudioFile) {
                audioMap[p.SteamID] = p.AudioFile;
            }
        });
    }
    updateAudioMap();

    // Status polling while processing
    function startStatusPolling() {
        if (demoStatus === 'completed') return;

        document.getElementById('loadingModal').classList.add('active');
        document.querySelector('.loading-text').textContent = 'Processing demo...';

        statusPollInterval = setInterval(() => {
            fetch('/status?demo_id=' + demoID)
                .then(r => r.json())
                .then(data => {
                    if (data.status === 'completed') {
                        clearInterval(statusPollInterval);
                        if (data.players && data.players.length > 0) {
                            players = data.players;
                            updateAudioMap();
                            if (matchDataCache) {
                                renderTeams(matchDataCache);
                            } else {
                                fetchAndRenderTeams();
                            }
                        }
                        document.getElementById('loadingModal').classList.remove('active');
                    } else if (data.status === 'failed') {
                        clearInterval(statusPollInterval);
                        document.getElementById('loadingModal').classList.remove('active');
                        alert('Processing failed.');
                    }
                });
        }, 1500);
    }

    // Fetch and render teams
    function fetchAndRenderTeams() {
        if (!matchID) {
            renderFallback();
            return;
        }

        fetch('/faceit/match?matchid=' + matchID)
            .then(r => r.json())
            .then(data => {
                if (data.payload && data.payload.entityCustom && data.payload.entityCustom.teams) {
                    matchDataCache = data.payload;
                    renderTeams(data.payload);
                } else {
                    renderFallback();
                }
                document.getElementById('loadingModal').classList.remove('active');
            })
            .catch(() => {
                renderFallback();
                document.getElementById('loadingModal').classList.remove('active');
            });
    }

    // Render teams from match data
    function renderTeams(matchData) {
        const faction1 = matchData.entityCustom.teams.faction1;
        const faction2 = matchData.entityCustom.teams.faction2;

        // Update team names
        document.getElementById('team1Name').textContent = faction1.name;
        document.getElementById('team2Name').textContent = faction2.name;

        // Update match links
        if (matchID) {
            document.getElementById('frontendLink').href = 'https://www.faceit.com/en/cs2/room/' + matchID;
        }

        // Render team 1
        document.getElementById('team1Container').innerHTML = renderTeamPlayers(faction1);

        // Render team 2
        document.getElementById('team2Container').innerHTML = renderTeamPlayers(faction2);

        // Initialize audio players
        setTimeout(initAudioPlayers, 300);
    }

    // Render players for a team
    function renderTeamPlayers(team) {
        return team.roster.map(player => {
            const audioFile = audioMap[player.gameId] || null;
            const elo = player.elo || 0;
            const level = player.gameSkillLevel || 1;

            return `
                <div class="card player-card">
                    <div class="card-body">
                        <h5 class="card-title mb-1">
                            <a href="#" class="player-name">${player.nickname}</a>
                            <button class="btn btn-outline-primary history-btn ms-1" title="Player history">
                                <i class="fa fa-history"></i>
                            </button>
                            <span class="badge badge-elo rounded-pill float-end">${elo} ELO</span>
                        </h5>
                    </div>
                    ${audioFile ? `
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item p-0 m-0">
                            <div class="waveform-container" data-audio="/output/${audioFile}" onclick="seekAudio(event, this)">
                                <canvas class="waveform-canvas"></canvas>
                                <div class="waveform-progress"></div>
                            </div>
                        </li>
                        <li class="list-group-item p-0 m-0">
                            <input type="range" class="form-range volume-slider" min="0" max="2" value="1" step="0.01" onchange="setVolume(this)">
                        </li>
                    </ul>
                    ` : ''}
                    <div class="card-body p-1">
                        <div class="btn-group btn-group-sm">
                            <a href="https://steamcommunity.com/profiles/${player.gameId}" target="_blank" class="btn btn-outline-primary">STEAM</a>
                            <a href="https://www.faceit.com/en/players/${player.nickname}" target="_blank" class="btn btn-outline-primary">FrontEnd</a>
                            ${audioFile ? `
                            <button class="btn btn-primary play-btn" onclick="togglePlay(this)" data-audio="/output/${audioFile}">Play</button>
                            <a href="/output/${audioFile}" download class="btn btn-outline-primary" title="Download">DW</a>
                            ` : ''}
                        </div>
                        <audio class="d-none" ${audioFile ? `src="/output/${audioFile}"` : ''} preload="metadata"></audio>
                    </div>
                </div>
            `;
        }).join('');
    }

    // Fallback render when no match data
    function renderFallback() {
        const team1 = players.slice(0, Math.ceil(players.length / 2));
        const team2 = players.slice(Math.ceil(players.length / 2));

        document.getElementById('team1Container').innerHTML = team1.map(p => renderFallbackPlayer(p)).join('');
        document.getElementById('team2Container').innerHTML = team2.map(p => renderFallbackPlayer(p)).join('');

        setTimeout(initAudioPlayers, 300);
    }

    function renderFallbackPlayer(player) {
        const audioFile = player.AudioFile || audioMap[player.SteamID];
        const nickname = player.Nickname || 'Loading...';
        const elo = player.FaceitElo || 0;

        return `
            <div class="card player-card" data-steam-id="${player.SteamID}">
                <div class="card-body">
                    <h5 class="card-title mb-1">
                        <span class="player-name">${nickname}</span>
                        <button class="btn btn-outline-primary history-btn ms-1" title="Player history">
                            <i class="fa fa-history"></i>
                        </button>
                        ${elo > 0 ? `<span class="badge badge-elo rounded-pill float-end">${elo} ELO</span>` : ''}
                    </h5>
                </div>
                ${audioFile ? `
                <ul class="list-group list-group-flush">
                    <li class="list-group-item p-0 m-0">
                        <div class="waveform-container" data-audio="/output/${audioFile}" onclick="seekAudio(event, this)">
                            <canvas class="waveform-canvas"></canvas>
                            <div class="waveform-progress"></div>
                        </div>
                    </li>
                    <li class="list-group-item p-0 m-0">
                        <input type="range" class="form-range volume-slider" min="0" max="2" value="1" step="0.01" onchange="setVolume(this)">
                    </li>
                </ul>
                ` : ''}
                <div class="card-body p-1">
                    <div class="btn-group btn-group-sm">
                        <a href="https://steamcommunity.com/profiles/${player.SteamID}" target="_blank" class="btn btn-outline-primary">STEAM</a>
                        ${nickname !== 'Loading...' ? `<a href="https://www.faceit.com/en/players/${nickname}" target="_blank" class="btn btn-outline-primary">FrontEnd</a>` : ''}
                        ${audioFile ? `
                        <button class="btn btn-primary play-btn" onclick="togglePlay(this)" data-audio="/output/${audioFile}">Play</button>
                        <a href="/output/${audioFile}" download class="btn btn-outline-primary">DW</a>
                        ` : ''}
                    </div>
                    <audio class="d-none" ${audioFile ? `src="/output/${audioFile}"` : ''} preload="metadata"></audio>
                </div>
            </div>
        `;
    }

    // Audio controls
    function togglePlay(btn) {
        const card = btn.closest('.player-card');
        const audio = card.querySelector('audio');
        if (!audio) return;

        if (audio.paused) {
            // Pause all other audio
            document.querySelectorAll('audio').forEach(a => {
                if (a !== audio) {
                    a.pause();
                    const otherBtn = a.closest('.player-card')?.querySelector('.play-btn');
                    if (otherBtn) otherBtn.textContent = 'Play';
                }
            });
            audio.play();
            btn.textContent = 'Pause';
        } else {
            audio.pause();
            btn.textContent = 'Play';
        }
    }

    function setVolume(slider) {
        const card = slider.closest('.player-card');
        const audio = card.querySelector('audio');
        if (audio) audio.volume = slider.value;
    }

    function seekAudio(event, container) {
        const card = container.closest('.player-card');
        const audio = card.querySelector('audio');
        if (!audio || !audio.duration) return;

        const rect = container.getBoundingClientRect();
        const x = event.clientX - rect.left;
        audio.currentTime = (x / rect.width) * audio.duration;
    }


    // Initialize audio players with waveforms
    function initAudioPlayers() {
        document.querySelectorAll('.waveform-container').forEach(container => {
            const card = container.closest('.player-card');
            const audio = card.querySelector('audio');
            const canvas = container.querySelector('.waveform-canvas');
            const progress = container.querySelector('.waveform-progress');

            if (!audio || !canvas) return;

            audio.volume = 0.8;

            // Draw waveform
            drawWaveform(audio, canvas);

            // Update progress
            audio.addEventListener('timeupdate', () => {
                if (audio.duration) {
                    progress.style.width = (audio.currentTime / audio.duration * 100) + '%';
                }
            });

            audio.addEventListener('ended', () => {
                const btn = card.querySelector('.play-btn');
                if (btn) btn.textContent = 'Play';
            });
        });
    }

    function drawWaveform(audio, canvas) {
        if (!audio.src) return;

        fetch(audio.src)
            .then(r => r.arrayBuffer())
            .then(buffer => {
                const ctx = new (window.AudioContext || window.webkitAudioContext)();
                return ctx.decodeAudioData(buffer);
            })
            .then(audioBuffer => {
                const canvasCtx = canvas.getContext('2d');
                const width = canvas.width = canvas.offsetWidth * 2;
                const height = canvas.height = canvas.offsetHeight * 2;
                canvasCtx.scale(2, 2);

                const displayW = canvas.offsetWidth;
                const displayH = canvas.offsetHeight;

                const data = audioBuffer.getChannelData(0);
                const samples = 150;
                const blockSize = Math.floor(data.length / samples);
                const amplitudes = [];

                for (let i = 0; i < samples; i++) {
                    let sum = 0;
                    for (let j = 0; j < blockSize; j++) {
                        sum += Math.abs(data[i * blockSize + j] || 0);
                    }
                    amplitudes.push(sum / blockSize);
                }

                const max = Math.max(...amplitudes);
                const barW = displayW / samples;

                amplitudes.forEach((amp, i) => {
                    const h = (amp / max) * displayH * 0.85;
                    const y = (displayH - h) / 2;
                    canvasCtx.fillStyle = '#0d6efd';
                    canvasCtx.fillRect(i * barW, y, barW - 0.5, h);
                });
            })
            .catch(() => {
                // Fallback: random bars
                const canvasCtx = canvas.getContext('2d');
                const w = canvas.offsetWidth;
                const h = canvas.offsetHeight;
                for (let i = 0; i < 80; i++) {
                    const barH = Math.random() * h * 0.6 + h * 0.2;
                    canvasCtx.fillStyle = '#0d6efd';
                    canvasCtx.fillRect(i * (w/80), (h - barH)/2, w/80 - 1, barH);
                }
            });
    }

    // Initialize on load
    if (demoStatus !== 'completed') {
        startStatusPolling();
    } else if (matchDataCache) {
        renderTeams(matchDataCache);
    } else if (matchID) {
        fetchAndRenderTeams();
    } else {
        renderFallback();
    }

    </script>
    {{end}}
    <script>

    // Form handlers
    document.getElementById('uploadForm')?.addEventListener('submit', function(e) {
        if (!document.getElementById('demoFile').files[0]) {
            e.preventDefault();
            alert('Please select a demo file');
            return;
        }
        document.getElementById('loadingModal').classList.add('active');
        document.querySelector('.loading-text').textContent = 'Uploading...';
        document.getElementById('submitButton').disabled = true;
    });

    document.getElementById('urlForm')?.addEventListener('submit', function(e) {
        const url = document.getElementById('matchroomURL').value.trim();
        if (!url || !url.includes('faceit.com') || !url.includes('/room/')) {
            e.preventDefault();
            alert('Please enter a valid Faceit matchroom URL');
            return;
        }
        document.getElementById('loadingModal').classList.add('active');
        document.querySelector('.loading-text').textContent = 'Downloading demo...';
        document.getElementById('urlSubmitButton').disabled = true;
    });
    </script>
</body>
</html>
